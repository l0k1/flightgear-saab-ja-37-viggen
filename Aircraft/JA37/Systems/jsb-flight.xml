<?xml version="1.0"?>

<system name="flight">

    <channel execrate="4" name="Aerodynamic info">

        <fcs_function name="systems/flight/axial-force-lb">
            <function>
                <sum>
                    <property>aero/coefficient/CAtakeoff</property>
                    <property>aero/coefficient/CACanopy</property>
                    <property>aero/coefficient/CACanopyOff</property>
                    <property>aero/coefficient/CAElevonLeft</property>
                    <property>aero/coefficient/CAElevonRight</property>
                    <property>aero/coefficient/CARudder</property>
                    <property>aero/coefficient/CAMissile1</property>
                    <property>aero/coefficient/CAMissile2</property>
                    <property>aero/coefficient/CAMissile3</property>
                    <property>aero/coefficient/CAMissile4</property>
                    <property>aero/coefficient/CAMissile5</property>
                    <property>aero/coefficient/CAMissile6</property>
                    <property>aero/coefficient/CAMissile7</property>
                    <property>aero/coefficient/CATank</property>
                    <property>aero/coefficient/CA</property>
                    <property>aero/coefficient/CAwave</property>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/normal-force-lb">
            <function>
                <sum>
                    <property>aero/coefficient/CN</property>
                    <property>aero/coefficient/CNGnd</property>
                    <property>aero/coefficient/CNGndElevator</property>
                    <property>aero/coefficient/CNflaps</property>
                    <property>aero/coefficient/CNwave</property>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/lift-force-lb">
            <function>
                <difference>
                    <product>
                        <property>systems/flight/normal-force-lb</property>
                        <cos>
                            <property>aero/alpha-rad</property>
                        </cos>
                    </product>
                    <product>
                        <property>systems/flight/axial-force-lb</property>
                        <sin>
                            <property>aero/alpha-rad</property>
                        </sin>
                    </product>
                </difference>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/drag-force-lb">
            <function>
                <sum>
                    <product>
                        <property>systems/flight/normal-force-lb</property>
                        <sin>
                            <property>aero/alpha-rad</property>
                        </sin>
                    </product>
                    <product>
                        <property>systems/flight/axial-force-lb</property>
                        <cos>
                            <property>aero/alpha-rad</property>
                        </cos>
                    </product>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/excess-thrust-lb">
            <function>
                <difference>
                    <property>propulsion/engine/thrust-lbs</property>
                    <property>systems/flight/drag-force-lb</property>
                </difference>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/lift-drag-ratio">
            <function>
                <quotient>
                    <property>systems/flight/lift-force-lb</property>
                    <property>systems/flight/drag-force-lb</property>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/thrust-weight-ratio">
            <function>
                <quotient>
                    <property>propulsion/engine/thrust-lbs</property>
                    <property>inertia/weight-lbs</property>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/lift-weight-ratio">
            <function>
                <quotient>
                    <property>systems/flight/lift-force-lb</property>
                    <property>inertia/weight-lbs</property>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/thrust-drag-ratio">
            <function>
                <quotient>
                    <property>propulsion/engine/thrust-lbs</property>
                    <property>systems/flight/drag-force-lb</property>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/turning-radius-nm">
            <function>
                <abs>
                    <quotient>
                        <product>
                            <product>
                                <property>velocities/vg-fps</property>
                                <value>0.000164578834</value>
                                <!-- convert fps to nm/sec -->
                            </product>
                            <quotient>
                                <product>
                                    <pi/>
                                    <value>2.0</value>
                                </product>
                                <property>velocities/psidot-rad_sec</property>
                            </quotient>
                        </product>
                        <product>
                            <pi/>
                            <value>0.5</value>
                        </product>
                    </quotient>
                </abs>
            </function>
        </fcs_function>

        <fcs_function name="names/flight/reverser-position">
            <function>
                <difference>
                    <value>1</value>
                    <property>/engines/engine/reverser-pos-norm</property>
                </difference>
            </function>
            <output>/engines/engine/reverser-position</output>
        </fcs_function>

        <switch name="aero/spin-norm">
            <default value="0"/>
            <test logic="OR" value="1">
                velocities/r-aero-rad_sec gt  0.724
                velocities/r-aero-rad_sec lt -0.724
            </test>
        </switch>
        
    </channel>

    <channel execrate="4" name="effects">

        <fcs_function name="effects/wingtip-vapour">
            <function>
                <and>
                   <gt>
                     <property>/velocities/airspeed-kt</property>
                     <value>120</value>
                   </gt>
                   <gt>
                     <property>/environment/relative-humidity</property>
                     <value>50</value>
                   </gt>
                   <or>
                     <lt>
                       <property>/position/altitude-ft</property>
                       <value>800</value>
                     </lt>
                      <gt>
                        <property>aero/alpha-deg</property>
                        <value>15.0</value>
                      </gt>
                   </or>
                   <lt>
                     <property>/environment/temperature-degc</property>
                     <value>20</value>
                   </lt>
                   <property>structural/wings/serviceable</property>
                 </and>
            </function>
        </fcs_function>

    </channel>

    <channel execrate="4" name="instruments">

        <!-- The ratio between N2 and N1 is approx 1:0.7184 -->

        <fcs_function name="propulsion/engine/aj37-n2-rpm_r-s">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine/n2</independentVar>
                    <tableData>
                        0.0        0.00
                       59.0      120.83
                       74.0      151.33
                       93.3      190.83
                       96.5      197.50
                       97.3      199.17
                      100.0      204.63
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/ja37-n2-rpm_r-s">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine/n2</independentVar>
                    <tableData>
                        0.0         0
                       57.0       118
                       70.5       149
                       88.5       181
                       93.9       192
                       94.8       194
                      100.0       204.6
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <switch name="propulsion/engine/n2-rpm_r-s">
            <default value="0"/>
            <test logic="OR" value="propulsion/engine/ja37-n2-rpm_r-s">
                /ja37/systems/variant == 0
            </test>
            <test logic="OR" value="propulsion/engine/aj37-n2-rpm_r-s">
                /ja37/systems/variant == 1
            </test>
        </switch>

        <fcs_function name="propulsion/engine/n2-rpm_r-min">
            <function>
                <product>
                    <property>propulsion/engine/n2-rpm_r-s</property>
                    <value>60</value>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/n1-rpm_r-min">
            <function>
                <product>
                    <property>propulsion/engine/n1</property>
                    <value>88</value>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/n1-rpm_r-s">
            <function>
                <quotient>
                    <property>propulsion/engine/n1-rpm_r-min</property>
                    <value>60</value>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/outlet-temperature-degc">
            <function>
                <quotient>
                    <difference>
                        <property>/engines/engine/egt-degf</property>
                        <value>32</value>
                    </difference>
                    <value>1.8</value>
                </quotient>
                <!--          <sum>
            <table>
              <independentVar lookup="row">propulsion/engine/thrust-lbs</independentVar>
              <tableData>
                  0.0         0
              35000.0       675
              </tableData>
            </table>
            <property>/environment/temperature-degc</property>
          </sum>-->
            </function>
        </fcs_function>

        <!-- page 137 of manual: mask oxygen supply -->
        <fcs_function name="systems/flight/oxygen-pressure-kPa">
            <function>
                <product>
                    <property>/controls/oxygen</property>
                    <table>
                        <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                        <tableData>
                                  0.0         0.1
                              59055.1         0.4 <!--  9000m cabin density alt / 18000m density alt -->
                              85301.8         6.7 <!-- 15000m cabin density alt / 26000m density alt -->
                        </tableData>
                    </table>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/environment-pressure-kPa">
            <function>
                <product>
                    <property>atmosphere/P-psf</property>
                    <value>0.047880258888979</value>
                </product>
            </function>
        </fcs_function>

        <!-- page 135 of manual -->
        <fcs_function name="systems/flight/closed-canopy-cabin-pressure-kPa">
            <function>
                <sum>
                    <property>systems/flight/environment-pressure-kPa</property>
                    <table>
                        <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                        <tableData>
                                  0.0         0.0   
                              16404.2        19.6 <!--  5000m density alt -->
                              65616.8        23.5 <!-- 20000m density alt -->
                        </tableData>
                    </table>
                </sum>
            </function>
        </fcs_function>

        <switch name="systems/flight/cabin-pressure-kPa">
            <default value="systems/flight/closed-canopy-cabin-pressure-kPa"/>
            <test logic="OR" value="systems/flight/environment-pressure-kPa">
              fcs/canopy/pos-norm ne 0
          </test>
        </switch>

        <fcs_function name="systems/flight/cabin-pressure-kpm2">
            <!-- kilopond per square cm2-->
            <function>
                <product>
                    <property>systems/flight/cabin-pressure-kPa</property>
                    <value>0.010197162129779</value>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/brake-pressure-kPa">
            <function>
                <product>
                    <property>/controls/gear/brake-left</property>
                    <property>gear/unit[1]/WOW</property>
                    <table>
                        <independentVar lookup="row">velocities/vg-fps</independentVar>
                        <tableData>
                              0         0.0
                            320         3.5
                        </tableData>
                    </table>
                </product>
            </function>
        </fcs_function>

        <switch name="systems/flight/aoa-indicator">
            <default value="aero/alpha-deg"/>
            <test logic="OR" value="/instrumentation/attitude-indicator/indicated-pitch-deg">
                gear/unit[0]/WOW == 1
            </test>
        </switch>    

        <fcs_function name="systems/flight/buffeting/output">
            <function>
                <product>
                    <sum>
                        <sin>
                          <product>
                            <property>sim-time-sec</property>
                            <property>systems/flight/buffeting/var1</property>
                          </product>
                        </sin>
                        <sin>
                          <product>
                            <property>sim-time-sec</property>
                            <property>systems/flight/buffeting/var2</property>
                          </product>
                        </sin>
                        <sin>
                          <product>
                            <property>sim-time-sec</property>
                            <property>systems/flight/buffeting/var3</property>
                          </product>
                        </sin>
                    </sum>
                    <table>
                        <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                        <tableData>
                              0.0         1.0
                          30000.0         0.0
                        </tableData>
                    </table>
                    <property>systems/flight/buffeting/magnitude</property>
                </product>
            </function>
        </fcs_function>
    
    </channel>

    <channel execrate="2" name="blinkers">

        <fcs_function name="systems/flight/blink/five">
            <function>
                <integer>
                  <mod>
                    <product>
                        <property>sim-time-sec</property>
                        <value>5</value>
                    </product>
                    <value>2</value>
                  </mod>
                </integer>
            </function>
            <output>/ja37/blink/five-Hz/state</output>
        </fcs_function>

        <fcs_function name="systems/flight/blink/ten">
            <function>
                <integer>
                  <mod>
                    <product>
                        <property>sim-time-sec</property>
                        <value>10</value>
                    </product>
                    <value>2</value>
                  </mod>
                </integer>
            </function>
            <output>/ja37/blink/ten-Hz/state</output>
        </fcs_function>

        <fcs_function name="systems/flight/blink/third">
            <function>
                <integer>
                    <min>
                        <mod>
                            <product>
                                <property>sim-time-sec</property>
                                <value>1</value>
                            </product>
                            <value>3</value>
                        </mod>
                        <value>1.99999999</value>
                    </min>
                </integer>
            </function>
            <output>/ja37/blink/third-Hz/state</output>
        </fcs_function>
    
    </channel>

</system>
